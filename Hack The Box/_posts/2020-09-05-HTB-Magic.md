---
layout: post
title:  "HTB-Magic"
description: Hack the Box - Magic Machine.
tags: HTB Magic
---
# Brief Summary

Magic Mahcine has very realistic vulerbaility, specially the one that is related to web application.

![machine](/assets/magic/machine.png)

# Nmap 

First I started with **nmap** tool and provided the option **`-A`**. 

here is the result:
```nmap
# Nmap 7.80 scan initiated Sat May 23 01:52:13 2020 as: nmap -A -oN nmap_scan-A 10.10.10.185
Nmap scan report for 10.10.10.185
Host is up (0.16s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)
|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Magic Portfolio
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat May 23 01:52:44 2020 -- 1 IP address (1 host up) scanned in 30.22 seconds
```

It looks like we have two ports open for now.

# Enumeration

lets take a look at the application hosted on port **80** if any...

![1](/assets/magic/1.png)

if you noticed, in the bottom left corner there is a login button.


![2](/assets/magic/2.png)

Try default creds like 'admin:admin', but nothing worked.

lets started up **Burp Suite** and intercept the traffic and catpure the login request.

![3](/assets/magic/3.png)

now send it to repeater. (CTRL + R) will do it. Since we have the HTTP login request lets manipulate the paremeters. In other word, lets abuse them.

here is the paremeters:
```json
username=admin&password=admin
```

what will happen if we send single qoute before **admin** word...

it appears nothing changed in the response. `200 OK` is the server response. 

lets try by adding `' or '=` as this considered to be DB query. If we get different response or sql errer. Thats mostly means we have SQL Injection vulnerability.

```json
username=admin' or '=&password=admin
```

Nice, looks like we have a different response. A redirection from the server `HTTP/1.1 302 Found`.

![4](/assets/magic/4.png)

Now we can officially say that we have **SQL Injection** attack. 

# Sqli & More Enumeratation

lets grab the login HTTP request from **Repeater** in **Burp Suite** and save to a file.

start sqlmap tools with providing the following options:
```sqlmap
sqlmap -r r -p username --random-agent --level 3 --batch
```
while this is running, let get to the redirection part. 

following redirection leads us to a page where upload functionality exists.

first thing comes to mind is file upload restriction issues, hence the name of the machine is "Magic" and a famous technique to prevent "malicious File Upload" in development word is called "Magic Number". 

Where a developer can implement "Magic Number" and chooses a specific type of files to be accepted and saved on the server. 

It called "Magic Number" becuase, it reads the first 4 bytes of the file. Matching it with file extenstion to determine whether to accept or refuse based on the extension and file signature that the developer hardcoded in the application.

Now lets try upload an image.